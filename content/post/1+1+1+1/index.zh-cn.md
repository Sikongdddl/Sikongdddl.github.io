---
title: 1+1+1+1游戏
description: 这是一个副标题
date: 2020-09-09

image: helena-hertz-wWZzXlDpMog-unsplash.jpg
categories:
    - program
---

## Introduction
我小的时候玩过这样的一个游戏：

两个人面对面，伸出双手做“1”的手势，然后依次行动

每次行动时，用自己的一只手碰对方的一只手，并把自己这只手上的数字变成二者的和

如果和为10 就把这一只手放下

率先放下两只手的人获胜

我小的时候在想，这个游戏的背后是否有某种最优策略？其中的“标准解法”和对应的数学模型又该如何得到呢？

如今我拥有了扎实的代码水平和不扎实的数学基础，决定来对这个儿时的问题进行一些深入研究。

## 工欲善其事，必先利其器
由于数学太烂，我的代码水平显著强于数学水平，想不明白就先用代码多玩几次，规律可能自己就出来了。

所以我首先完成了这个游戏的一个简单的模拟器和日志输出

>强烈建议没玩过这个游戏的来和我玩一次 不然下面的东西可能会把人看晕

下面为随机一次游戏的日志：其中，开始的四个数字代表两个人四只手的当前状态。

顺序为：p1左手，p1右手，p2左手，p2右手

> 轮数: 0
> 
> 1 1
> 1 1
> p1行动
> 行动者使用右手
> 触碰对方左手
> 
> 轮数: 1
> 
> 1 2
> 1 1
> p2行动
> 行动者使用左手
> 触碰对方左手
> 
> 轮数: 2
> 
> 1 2
> 2 1
> p1行动
> 行动者使用左手
> 触碰对方右手
> 
> 轮数: 3
> 
> 2 2
> 2 1
> p2行动
> 行动者使用左手
> 触碰对方右手
> 
> 轮数: 4
> 
> 2 2
> 4 1
> p1行动
> 行动者使用左手
> 触碰对方右手
> 
> 轮数: 5
> 
> 3 2
> 4 1
> p2行动
> 行动者使用右手
> 触碰对方左手
> 
> 轮数: 6
> 
> 3 2
> 4 4
> p1行动
> 行动者使用右手
> 触碰对方左手
> 
> 轮数: 7
> 
> 3 6
> 4 4
> p2行动
> 行动者使用右手
> 触碰对方右手
> 
> 轮数: 8
> 
> 3 6
> 4 0
> p1行动
> 行动者使用右手
> 对方只有左手
> 
> 轮数: 9
> 
> 3 0
> 4 0
> p2行动
> 行动者只有左手
> 对方只有左手
>
> 轮数: 10
> 
> 3 0
> 7 0
> p1行动
> 行动者只有左手
> 对方只有左手
> 
> game over!
>

## 实验
既然有了这样一个模拟器，让它帮我跑一些实验也就十分自然了。

### 统计模拟

我们高强度使用模拟器，让双方以完全随机的策略玩这个游戏几万次（CPU震怒），并在此过程中收集一些统计信息。

> 显而易见的是，我们在进行大批量的实验前应该担心这个游戏是否存在”死局“，即两位游戏者陷入无论使用什么策略都无法结束的局面。
>
> 直接说结论，在其中一人剩余两只手时，游戏最终一定会进入每人只剩一只手的局面，或者直接结束。
>
> 在每人只剩一只手时，根据我过往的经验，这个游戏在某些时候会陷入无尽的循环。例如2遇到1，2先手时。有兴趣的朋友可以自己试一下。
>
> 由于后续测得平均一局游戏的步数是27步左右，因此在这里我粗暴地认为，当一局游戏进行了200步还没有结束时，就视作已经陷入无尽循环流局，直接开始下一局。
>

以下是实验结果：当我们认为超过200个episode为流局时数据如下：

|         实验序号         | 先手获胜 | 后手获胜 | 流局 |
| :----------------------: | :------: | :------: | :--: |
|            1             |   451    |   445    | 104  |
|            2             |   424    |   470    | 106  |
|            3             |   415    |   474    | 111  |
|      4（十倍样本）       |   4224   |   4685   | 1091 |
| 5（2000episode判定流局） |   485    |   395    | 120  |

在前三次实验中，我们进行一千次游戏。
第四次实验为压力测试，进行了一万次游戏。
第五次实验为对照试验，将认为流局的标准从200步放宽到了2000步。

这个结果非常的amazing啊！（毕导脸）

平均来看，不流局的比赛中，平均每一局进行了27.5轮，这个游戏的节奏还是很快的，哪怕策略是随机的。

>因此跑这些实验消耗的时间还不及debug的一半（划掉

除此之外，我们发现了两件奇怪的事：
* 在完全随机决策的情况下，先手胜率明显低于后手。而当对随机的容忍足够高时，先手胜率又略高于后手。但流局概率基本稳定。
* 这个游戏居然有高达百分之十的流局概率

其中，关于先手优胜问题，由于表现并不十分稳定，并没有吸引我足够多的注意力。

但后者，关于流局这件事，深深的吸引了我。

因此这篇博客从此正式跑偏，从研究最优策略转为研究流局问题。

### 流局

只需要略微改动下代码，把流局的情况最后一幕拿出来观赏一下即可发现：

所有流局情况同胚 属于这样一个循环之中：

(2 1)->[3 1]->(3 4)->[7 4]->(7 1)->[8 1]->(8 9)->[7 9]->(7 6)->[3 6]->(3 9)->[2 9]->(2 1)

其中，用小括号括起来表示左边先手，用中括号则反之

乍一看好像没有什么规律，但我们可以对它进行一个简单的处理。
至于为什么要这么处理，我们后面再说~

将所有右边先手的情况进行两个坐标的交换，并认为这是一次左边先手的情况，那么这是一种等价变换。
这是显然的，例如：

>(2 1)表示当前我的手比了个2，你的手比了个1，轮到我先动。
>
>[1 2]表示当前我的手比了个1，你的手比了个2，轮到你先动。

变换后我们得到：
>2 1->3 1->3 4->7 4->7 1->8 1->8 9->7 9->7 6->3 6->3 9->2 9->2 1

### 流局中的数学
前面我们已经讨论过，流局只发生在双方都只剩一只手的情况下。

这是一个相对平凡的情况，比较适合进行一个数学建模。
当两个人都只有一只手时，下面这个矩阵可以代表全部的起始情况：

let E = 

[2 3 4 5 6 7 8 9 0]

[3 4 5 6 7 8 9 0 1]

[4 5 6 7 8 9 0 1 2]

[5 6 7 8 9 0 1 2 3]

[6 7 8 9 0 1 2 3 4]

[7 8 9 0 1 2 3 4 5]

[8 9 0 1 2 3 4 5 6]

[9 0 1 2 3 4 5 6 7]

[0 1 2 3 4 5 6 7 8]

其中：Eij表示p1为i p2为j时 p1先手相加后p1的结果

>比如说，E11=2，意思就是，当我手上是1，你手上也是1的时候，我一碰你我就变成2了

这是一个满秩的矩阵（雾）

每一次加法的本质是一次行变换/列变换，具体来说，比如i从1变成了2，本质上就是第一行与第二行交换 而这是不改变矩阵的秩的

游戏的结束条件是当E（1，1）变成0时，自己是后手

也许从这里出发可以得到这个游戏的“最优策略”，但是一心泡在那个流局上的我今天不想研究他了（雾），欢迎有兴趣的朋友issue我，我们一起继续玩

我们把导致流局的起始条件在矩阵中标黑，我们就会得到一个很有趣的矩阵：
(这里如果开了暗色模式很可能看不清楚，建议切换一下，让你们看看这个淡粉色的主题)

[2 3 **4** 5 6 7 8 **9** 0]

[**3** 4 5 6 7 8 9 0 1]

[4 5 6 **7** 8 9 0 1 **2**]

[5 6 7 8 9 0 **1** 2 3]

[6 7 8 9 0 1 2 3 4]

[7 8 **9** 0 1 2 3 4 5]

[**8** 9 0 1 2 **3** 4 5 6]

[9 0 1 2 3 4 5 6 **7**]

[0 **1** 2 3 4 5 **6** 7 8]

至此我们部分解决了之前的一个问题：为什么流局的概率高达百分之十几
>展开解释一下：
>
>这个矩阵中，每一个值都代表着一种“游戏状态”。比如E13，就代表着当一只手是1，另一只手是3的时候，1的那只手先手，接下来会得到的值是E13。
那么在全部的9*9=81这么大的概率空间内，有足足12个点会导致进入流局循环。这也就意味着，我们假设在游戏变成一只手对一只手的时候，出现这81种局面的概率相同，那么游戏就有12/81的概率进入流局循环，最终流局。
这个概率约等于14.8%，比我们测出来的还要高。
不匹配的原因显然是出现这81种局面的概率并不相同。
>
>具体从我们的1，1，1，1开局发展到这八十一种情况的概率怎么计算，我目前还没有想通。

然后自然而然的会提出以下几个问题：
* 为什么中心对称：坐标和互补的两个坐标，如果一个坐标会流局，那么另一个坐标也会。如果一个不会，那么另一个也不会。这个问题我也没有解决。
* 还有没有别的循环：这个问题比较朴素，由于一只手+一只手不存在“选择”的余地，暴力求解可知，不再有别的循环
* 为什么这一组循环会导致流局：这涉及到流局的本质，这个问题被我解决了，诸位看官请看。

### 流局的本质
让我们观察这个序列，不难发现它是一个有点意思的，性质类似于斐波那契数列的数对列

2 1->3 1->3 4->7 4->7 1->8 1->8 9->7 9->7 6->3 6->3 9->2 9->2 1

其中

> A11=2 A12=1
>
> A21=A12
>
> A22=A11+A12
>
> An1 = A(n-1)2
>
> An2=A(n-1)1+A(n-1)2
>
把这些可恶的重复去掉之后，我们得到了这样的一个数列：

2，1，3，4，7，1，8，9，7，6，3，9，2，1

前面的数对形式来自于我们以步长为1，去拿相邻的两个数。

这个数列：
* 对10取模
* 前两项与斐波那契数列不同

其他性质与斐波那契数列基本相同

经过检验后发现，只有前两项是这两个小倒霉时，这个数列才会在无尽的相加之中永远不出现尾数0，也就意味着永远无法达成凑出10让游戏结束的真实。

这就是这个游戏流局背后的数学啦。

奇妙的是，我当然不是第一个发现以这两个数字开头的斐波那契数列性质比较特殊的人。

第一个发现的人叫卢卡斯(Lucas)，大家感兴趣可以去搜一下Lucas sequence，它在解决斐波那契的相关问题中表现极为突出。
我们面对的这个数列就是它，只是被mod10了。

## 写在最后
我很爱这种探索的过程，即使儿时的游戏也能带给我无尽的快乐和挑战。
还有好多相关工作没有完成！

其实有点玩物丧志，如果这两天工作顺利，有空闲时间的话，我会回来继续更新的