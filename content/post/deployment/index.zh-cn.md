---
title: 全栈部署技术整理
description: 以nginx+docker+mysql为例
date: 2024-10-17

categories:
    - program
---

## 前言
2022年的暑假项目里，摆了全程没有帮到忙的我接下了最后一个部分的工作：部署。那次花了我三周的时间，最后在我的两位dalao朋友的帮助下顺利完成。

2024年的某个下午，我被赶鸭子上架，需要重新部署一遍自己的某个项目，从买服务器开始算起一共花了三个小时。

技术不能带给我足够的刺激正是因为如此，第二次做需要花费的时间和精力往往不及第一次的十分之一。

## web技术栈简介
部署的本质是把程序从运行在自己的电脑上，转为运行在服务器上。这个话说出来有点像讲脱口秀了，因为这个需求看起来真的很好笑。但至少在以下场合有实际意义：
* 只有服务器的性能才能满足实际需求，不会真的有人觉得自己的电脑运行12316可以让大家在春运的时候抢到火车票吧
* 自己的机器没有公网IP，无法被直接访问，又不敢去玩内网穿透那一套东西
* 甲方要求你这样做（雾）

当你流畅的网上冲浪，访问一个又一个网站时，这背后发生着一系列精巧的事情，我将一一介绍这些环节，并展示每一个环节在服务器上运行和在自己的机器上运行到底有什么不同。

一个完整的web技术栈至少由前端、后端、数据库这三部分组成。叫“技术栈”是因为它们按顺序一个个叠起来才能完成一款web应用的功能，这很像一个栈结构。

前端：

> 负责渲染、展示数据
>
> 由于更像美工，所以处在开发技术的鄙视链底端（雾）
> 
> 常用的开发语言与框架：html+css+javascript/react/vue...


后端：

> 负责实现业务逻辑
> 
> 任重而道远，完成前端甲方的要求，并与数据库交互
>
> 常用的开发语言与框架：java/c#/golang，以及世界上最好的语言：PHP

数据库：

> 负责存数据
> 
> 有人就要爆笑如雷，说为什么我不能用excel存数据非要用数据库呢
> 
> 常用的开发语言与框架：excel（不是）/mysql/redis/innoDB/mangoDB...
> 

形象地说，当你按下“登录微信”时，前端/后端/数据库是这样工作的：

* 前端：向后端发送登录请求，将用户名和密码交给后端
* 后端：在数据库中查询用户名和密码是否匹配，返回给前端匹配结果
* 前端：根据匹配结果渲染登陆成功页面或登陆失败页面

## 数据库部署
服务器数据库安装+远程连接（强烈推荐）
把大象放进冰箱 啊不是 把数据库放在服务器中总共分三步：下载，运行，维护数据。
没有使用过任何一种数据库，或者想问存数据为什么不用excel的同学可以关掉了，后面的笑点你可能get不到~

### 下载：
当服务器了就看清楚自己要下的是不是服务端，以用的人非常多的关系型数据库mysql为例，在ubuntu中mysql-server是我们需要的数据库服务器，而apt install mysql推荐的mysql-client-balabala不能上桌。

如果你使用的是另一种操作系统（windows除外），或另一种数据库，那么请去stack overflow上搜索“xx系统 xx服务器安装” 然后点开第一条帖子按顺序做。

### 运行：
虽然伟大的操作系统（如ubuntu）知道数据库应该一直运行，但有些不那么伟大的操作系统（如windows）并不知道，所以请谨慎仔细地检查你的数据库正在工作。不要一会登陆不上，一会连接失败，到处搜bug改配置文件越弄越乱。

在伟大的ubuntu中，可以通过systemctl status mysql来查看。如果你的操作系统不是伟大的ubuntu，也不是windows，那么你可以尝试把‘systemsctl’换掉，或者不用换。如果你的数据库不是mysql，那么你可以尝试把‘mysql’换掉。换成什么请参考stack overflow。

### 维护数据：
我相信很多人使用数据库时，手头已经有了一些数据需要放进去。这可能是之前的遗留数据，也可能是项目的启动数据。除非你想在往往没有图形化界面的服务器中一句一句写SQL，化身非洲民工时薪高达0.4$，否则请认真使用伟大的自动生成脚本功能。

绝大多数的主流数据库支持从数据表自动生成建表语句，如果你的数据格式并不是非常整齐，也可以借助伟大的生成式人工智能：谈天吉皮提来让它非常整齐。mysql有强大的mysqldump，几乎可以满足所有场合的数据-SQL转换需求。其它数据库请自行参考stack overflow。

### 远程连接：
众所周知啊，分三步的东西都有四步（雾）。事实上以上三步足以对服务器数据库进行使用和维护，但强烈推荐大家进行远程连接。现行的数据库可视化集成开发环境（如Navicat(交大邮箱激活免费使用一年)、Datagrip（jetbrain家的，交大邮箱激活免费使用一辈子））的强大超乎你的想象，可以十倍百倍的提升效率。

需要注意的是，mysql数据库默认禁止一切非localhost用户的访问，想远程连接mysql数据库，你往往需要：
* 打开访问ip限制（请去stack overflow）
* 确保用户名和密码可以登录mysql（请去stack overflow，并注意mysql8的密码机制与过往版本不同，不要念错了经）
* 确保服务器防火墙打开了mysql的端口（如果你的mysql密码过分脆弱（如123456），请绝对不要在使用复杂密码前这么做，否则早晚你的数据库会被扫描机扫进来删库勒索。）

## 后端部署
把小象放进冰箱里一共也分三步：打包，运行，报错之后悲鸣
### 打包：
除非你想把整个后端项目（这往往有几个G）都拖到服务器上运行和调试，否则先生成它的可执行版本绝对是正确的选择。
java在这件事上得天独厚，jar包内包括了完整的java运行环境，可以在绝大多数系统中运行。而java的主流框架（如springboot）常常整合了maven，让打包这件事变成了一键式的傻瓜操作。如果你使用的语言不是java，请参考stack overflow用其他方式完成打包这件事。

### 运行
如果你们服务器的上行带宽足够大，把整个项目挪到服务器里运行也并不是一件特别让人难接受的事，就是有点不优雅。从这个意义上，如果不追求优雅，后端的部署是相对最容易的。

对java来说，如果你的服务器中是一个jar包，那么你只需要java -jar运行它。对其它语言，当只能使用命令行时，在服务器内配置它的运行环境有时是一件让人抓狂的事，尤其是许多时候，各种版本之间复杂的依赖关系无法从报错中体现出来，需要更多的耐心。

### 悲鸣
由于后端项目需要与数据库非常频繁的交互，因此部署后端时看到花花绿绿的报错实在是再正常不过了。任何一个正常的人在抗压能力不那么强时，看到它们都会悲鸣。我曾经在这里卡了三天后，于项目晨会中大声悲鸣，并被助教和朋友共同安慰。

有效制止悲鸣的办法是分解任务，比如：
* 1.悲鸣，累了就不鸣了
* 2.狞笑（划掉）
* 2.如果使用了orm映射，认认真真比较后端中的表名、字段名、数据类型等与数据库中是否对应。注意是对应，不是一致。以java为例，JPA后端需要严格遵循驼峰命名，但mysql表的字段名需要严格遵循下划线命名。任何一张表的任何一个字段的任何一处没有对应上都无法被容忍。
* 3.在后端开发的过程中频繁使用postman在本地测试，不要写一千行代码之后自信满满的部署上去，一起debug。不要允许一些自己都不完全理解的代码存在于你的项目中。

Anything you can't create, You don't understand.

### Docker
这同样是一个没有必要做，却可以极大提高生产力的工具。

显而易见的是，对不同的开发环境，不同的服务器系统来说，配置环境总是一件让人崩溃的事。尤其是需要在同一台机器上存在多个环境时，它们之间的交互也让人生畏。Docker基于这种需求场景诞生。只要你配好了docker，你就再也不用配置环境了。

需要注意的是，docker的不同容器之间有强隔离，因此请务必认真学习容器间通信后再进行使用。不要搞出把后端和服务器分别放在两个容器中，然后想不明白后端为什么找不到服务器这种笑话。

## 前端部署
忙完这么一通之后，恭喜你已经离成功不远啦，最后一步要做的就是将前端也丢在服务器中运行。
这里就不把大象放在冰箱里了，因为几乎所有的“前端部署”都是通过反向代理完成的，而nginx是无人能出其右的反向代理技术。

想说明白反向代理是什么，就要说明白正向代理是什么，就要先说明白代理是什么。

有时我们无法直接访问一个网页，就像我们不能直接买到海外的产品一样，此时代理的作用跟代购基本是一样的。
正向代理指的是你知道自己要访问的代理服务器在哪里，比如你找一个在日本留学的朋友帮你买正版EVA漫画，那么这个朋友就是你的正向代理，而EVA漫画是你本来想要访问的目标。

反向代理指的是你只知道你想买EVA，却不知道自己有哪个朋友在日本留学，EVA主动联系了一位日本友人明日香把漫画书送到你的手上（雾）。

nginx就是这样的技术，我们的前端部署也是基于此实现的。当你访问服务器中被绑定好的IP时，你的终点会被nginx截获，并自动反向代理到你提前设置好的另一个界面中，这个设置好的界面当然就是你想部署的前端。

nginx的基本使用和语法非常简单，大家去stack overflow一学就会。但大部分linux系统中，nginx有一些重要的坑，请大家小心检查自己有没有掉到坑里：
* nginx的配置文件一般是/etc/nginx/nginx.conf 但nginx.conf常常因为各种原因解析失败，此时会调用另一个配置文件/etc/nginx/sites-enabled/default。在这个文件中配置也可以完成代理。需要小心的是，更新页面文件或配置文件后请执行nginx -s reload和systemctl restart nginx。
* 如果发现前端可以访问到，但在任何路由跳转后都直接返回404，这多半是前端框架的路由是通过history.push(/)实现的，偶尔会需要解析/index/html这个界面，而nginx默认的配置页是index.html，解决办法是在try files跳转到404页面前加入一条/index.html规则。


以上就是全部的部署过程。实际的部署也都是按照这个顺序进行。
这个顺序是为了定位问题。因为数据库出了问题只可能是数据库自己的问题；所以我们先部署数据库；
后端出了问题可能是后端或数据库的问题，所以我们在确定数据库正常工作后，可以部署后端；
前端出了问题有可能是任何地方的问题，所以我们最后部署前端。

当我第一次清理掉本地所有的应用程序，在浏览器中输入一个地址后正常访问着项目没有任何阻碍时，一种奇妙的，无法在任何地方体会到的自由感拥抱了我。我们部署的内容也许是自己的玩具，也许是甲方的需求，也许是真正解决着实际问题的重要项目。不管它是什么，它离互联网上那些形形色色的网站，只差花三十五块买一个域名了。

做到后记得恭喜自己攻克了一个领域，从此面对部署任务时请习惯被当作经验丰富的专家对待（）。

————司空

